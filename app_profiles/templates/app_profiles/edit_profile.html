{% extends "base.html" %}
{% load static %}

{% block title %}Edit Profile{% endblock %}

{% block content %}
{# Page-local lighter backdrop (no base.html edits) #}
<div class="absolute inset-0 -z-10 bg-gradient-to-b from-neutral-900/40 via-neutral-800/40 to-neutral-900/40"></div>

{# Centered horizontally, balanced vertical padding #}
<div class="w-full max-w-2xl mx-auto px-4 py-2">
  <div class="rounded-2xl p-6 md:p-10 shadow-lg backdrop-blur
              bg-neutral-800/50 border border-white/15">
    {# Darker heading (closer to nav button background tone) #}
    <h1 class="text-3xl font-bold mb-8 text-center text-neutral-200 tracking-tight">
      Edit Your Profile
    </h1>

    <form method="post" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      {{ user_form.non_field_errors }}
      {{ profile_form.non_field_errors }}

      <!-- Username -->
      <div class="max-w-md">
        <label for="{{ user_form.username.id_for_label }}" class="block font-semibold mb-1 text-white/80">
          Username
        </label>
        <input
          type="text"
          name="{{ user_form.username.name }}"
          id="{{ user_form.username.id_for_label }}"
          value="{{ user_form.username.value }}"
          placeholder="Enter username"
          class="w-full p-3 rounded-lg text-white placeholder-white/60
                 bg-neutral-900/5 border border-white/50
                 focus:outline-none focus:ring-2 focus:ring-blue-300/40 focus:border-white/30"
        >
        {% for error in user_form.username.errors %}
          <p class="text-red-400 text-sm mt-1">{{ error }}</p>
        {% endfor %}
      </div>

      <!-- Email -->
      <div class="max-w-md">
        <label for="{{ user_form.email.id_for_label }}" class="block font-semibold mb-1 text-white/80">
          Email
        </label>
        <input
          type="email"
          name="{{ user_form.email.name }}"
          id="{{ user_form.email.id_for_label }}"
          value="{{ user_form.email.value }}"
          placeholder="Enter email"
          class="w-full p-3 rounded-lg text-white placeholder-white/60
                 bg-neutral-900/5 border border-white/50
                 focus:outline-none focus:ring-2 focus:ring-blue-300/40 focus:border-white/30"
        >
        {% for error in user_form.email.errors %}
          <p class="text-red-400 text-sm mt-1">{{ error }}</p>
        {% endfor %}
      </div>

      <!-- First Name -->
      <div class="max-w-md">
        <label for="{{ user_form.first_name.id_for_label }}" class="block font-semibold mb-1 text-white/80">
          First Name
        </label>
        <input
          type="text"
          name="{{ user_form.first_name.name }}"
          id="{{ user_form.first_name.id_for_label }}"
          value="{{ user_form.first_name.value }}"
          placeholder="Enter first name"
          class="w-full p-3 rounded-lg text-white placeholder-white/60
                 bg-neutral-900/5 border border-white/50
                 focus:outline-none focus:ring-2 focus:ring-blue-300/40 focus:border-white/30"
        >
        {% for error in user_form.first_name.errors %}
          <p class="text-red-400 text-sm mt-1">{{ error }}</p>
        {% endfor %}
      </div>

      <!-- Last Name -->
      <div class="max-w-md">
        <label for="{{ user_form.last_name.id_for_label }}" class="block font-semibold mb-1 text-white/80">
          Last Name
        </label>
        <input
          type="text"
          name="{{ user_form.last_name.name }}"
          id="{{ user_form.last_name.id_for_label }}"
          value="{{ user_form.last_name.value }}"
          placeholder="Enter last name"
          class="w-full p-3 rounded-lg text-white placeholder-white/60
                 bg-neutral-900/5 border border-white/50
                 focus:outline-none focus:ring-2 focus:ring-blue-300/40 focus:border-white/30"
        >
        {% for error in user_form.last_name.errors %}
          <p class="text-red-400 text-sm mt-1">{{ error }}</p>
        {% endfor %}
      </div>

      <!-- Avatar -->
      <div>
        <label for="{{ profile_form.avatar.id_for_label }}" class="block font-semibold mb-1 text-white/80">
          Avatar (optional)
        </label>
        <input
          type="file"
          name="{{ profile_form.avatar.name }}"
          id="{{ profile_form.avatar.id_for_label }}"
          class="w-full p-2 rounded-lg text-white
                 bg-neutral-900/5 border border-white/50
                 file:bg-neutral-800/70 file:text-white file:border-0 file:px-3 file:py-2
                 hover:file:bg-neutral-800/60 focus:outline-none focus:ring-2 focus:ring-blue-300/40"
        >
        {% if profile_form.instance.avatar %}
          <img
            src="{{ profile_form.instance.avatar.url }}"
            alt="Avatar"
            class="mt-3 w-32 h-32 rounded-full object-cover border border-white/50"
          >
        {% endif %}
        {% for error in profile_form.avatar.errors %}
          <p class="text-red-400 text-sm mt-1">{{ error }}</p>
        {% endfor %}
      </div>

      <!-- Feedback -->
      <div>
        <label for="{{ profile_form.feedback.id_for_label }}" class="block font-semibold mb-1 text-white/80">
          Feedback (about this site)
        </label>
        <textarea
          name="{{ profile_form.feedback.name }}"
          id="{{ profile_form.feedback.id_for_label }}"
          placeholder="Share your feedback about the site"
          class="w-full p-4 h-20 resize-y rounded-lg text-white placeholder-white/60
                 bg-neutral-900/5 border border-white/50
                 focus:outline-none focus:ring-2 focus:ring-blue-300/40 focus:border-white/30"
        >{{ profile_form.feedback.value }}</textarea>
        {% for error in profile_form.feedback.errors %}
          <p class="text-red-400 text-sm mt-1">{{ error }}</p>
        {% endfor %}
      </div>

      {# Light, muted blue primary action #}
      <button
        type="submit"
        class="w-full rounded-lg font-semibold p-3
               bg-blue-200 text-neutral-900 hover:bg-blue-100 hover:text-black
               focus:outline-none focus:ring-2 focus:ring-blue-300/50 transition"
      >
        Save Changes
      </button>
    </form>

    {# --- Delete account trigger (small muted red text) --- #}
    <p class="mt-6 text-sm text-red-400/70 text-center">
      Want to delete your account?
      <button id="openDeleteModal" type="button" class="underline hover:text-red-300">
        Delete profile
      </button>
    </p>
  </div>
</div>

{# --- Modal for delete account --- #}
<div id="deleteModal"
     class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/60"
     role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle" aria-hidden="true">
  <div class="w-full max-w-md rounded-2xl bg-neutral-800 border border-white/10 p-6">
    <h2 id="deleteModalTitle" class="text-lg font-semibold text-red-300">Delete your account?</h2>
    <p class="mt-2 text-sm text-neutral-300">
      This permanently deletes your account and related data. This canâ€™t be undone.
    </p>

    <form method="post" action="{% url 'account-delete' %}" class="mt-6 space-y-4">
      {% csrf_token %}

      <label class="block text-sm">
        Type <span class="font-mono">DELETE</span> to confirm
        <input id="confirmInput" name="confirm_text" autocomplete="off"
               class="mt-2 w-full rounded-lg border border-neutral-600 bg-neutral-700 px-3 py-2 text-sm"
               placeholder="DELETE">
      </label>

      <!-- simple server-side on/off gate -->
      <input type="hidden" name="confirm" value="on">

      <div class="mt-4 flex items-center justify-end gap-3">
        <button id="cancelDelete" type="button"
                class="px-4 py-2 rounded-xl bg-neutral-700 hover:bg-neutral-600">
          Cancel
        </button>
        <button id="confirmDeleteBtn" type="submit" disabled
                class="px-4 py-2 rounded-xl bg-red-600/60 hover:bg-red-500 disabled:opacity-50 disabled:cursor-not-allowed">
          Delete account
        </button>
      </div>
    </form>
  </div>
</div>

<script src="{% static 'js/delete_account.js' %}" defer></script>
{% endblock %}
